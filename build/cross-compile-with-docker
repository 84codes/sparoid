#!/bin/bash -eux
srcfile=$1
image=${2:-ubuntu:20.04}
strip=$3

buildcmd=$(env CFLAGS="-fPIC" crystal build --cross-compile --target=aarch64-unknown-linux-gnu --release "$srcfile")
buildcmd=$(echo $buildcmd | sed "s|$PWD|/work|")

if ! (grep -q '"experimental": true' /etc/docker/daemon.json)
then
  echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
  sudo systemctl restart docker
  sudo apt-get install -y --no-install-recommends qemu-user-static
fi

mkdir -p bin/

docker run --rm --platform arm64 -v "$PWD":/work -i "$image" /bin/bash << EOF
set -eux
apt-get update
apt-get install -y wget clang libssl-dev libpcre3-dev libgc-dev libevent-dev zlib1g-dev

cd /work
cc -Wall -O3 -c lib/fdpass/src/fdpass.c -o lib/fdpass/src/fdpass.o
$buildcmd
rm $(basename "$srcfile" .cr).o
mv $(basename "$srcfile" .cr) bin/
[ -n "$strip" ] && strip bin/$(basename "$srcfile" .cr)
EOF
